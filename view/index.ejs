<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="search">
        <form action="" id="search_form">
            <input type="text" placeholder="Website">
            <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
        </form>
    </div>
    <div class="table-container">
        <div class="thead">
            <div class="tr">
                <div class="th no">STT</div>
                <div class="th web" style="color: #fff; text-decoration: none; font-style: normal;">Website</div>
                <div class="th adsPosition">Tên vị trí</div>
                <div class="th dimensions">Kích thước (px)</div>
                <div class="th platform">Nền tảng</div>
                <div class="th demo" style="color: #fff; text-decoration: none; font-style: normal;">Demo</div>
                <div class="th buyingMethod">Cách tính giá</div>
                <div class="th detail">
                    <div>Đơn giá</div>
                    <div>&</div>
                    <div>Hiệu suất</div>
                </div>
                <div class="th note">Note</div>
                <div class="th action"></div>
            </div>
        </div>
        <div class="tbody">
            <% let cur = 1, noSame = 0, adsSame = 0, platformSame = 0, demoSame = 0, trans; %>
            <% for (let i = 0; i < sheets.length; i++) { %>
                <% if (sheets[i].no == cur) { %>
                    <div class="header-web <%= cur % 2 != 0 ? 'red' : 'orange' %>"><%- sheets[i].website.toUpperCase() %></div>
                    <% cur++; %>
                <% } %>
                <div class="tr">
                    <!-- set no, website -->
                    <% if (noSame) { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no) { %>
                            <% noSame++; %>
                            <div class="td no noTop noBot"></div>
                            <div class="td web noTop noBot" name="website_<%= sheets[i].website %>"></div>
                        <% } else { %>
                            <% trans = -1 * noSame / 2.0 * 42.6 %>
                            <div class="td no noTop"><div style="transform: translateY(<%- trans %>px);"><%= sheets[i].no %></div></div>
                            <div class="td web noTop" data-link="https:<%= sheets[i].website %>" name="website_<%= sheets[i].website %>"><div style="transform: translateY(<%- trans %>px); overflow-x: hidden;"><%= sheets[i].website %></div></div>
                            <% noSame = 0; %>
                        <% } %>
                    <% } else { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no) { %>
                            <% noSame++; %>
                            <div class="td no noBot"></div>
                            <div class="td web noBot" name="website_<%= sheets[i].website %>" data-link="https:<%= sheets[i].website %>"></div>
                        <% } else { %>
                            <div class="td no"><%= sheets[i].no %></div>
                            <div class="td web" style="overflow-x: hidden;" data-link="https:<%= sheets[i].website %>" name="website_<%= sheets[i].website %>"><%= sheets[i].website %></div>
                            <% noSame = 0; %>
                        <% } %>
                    <% } %>

                    <!-- set adsPosition, dimensions -->
                    <% if (adsSame) { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no && sheets[i].adsPosition == sheets[i+1].adsPosition) { %>
                            <% adsSame++; %>
                            <div class="td adsPosition noTop noBot"></div>
                            <div class="td dimensions noTop noBot"></div>
                        <% } else { %>
                            <% trans = -1 * adsSame / 2.0 * 42.6 %>
                            <div class="td adsPosition noTop"><div style="transform: translateY(<%- trans %>px);"><%= sheets[i].adsPosition %></div></div>
                            <div class="td dimensions noTop"><div style="transform: translateY(<%- trans %>px);"><%= sheets[i].dimensions %></div></div>
                            <% adsSame = 0; %>
                        <% } %>
                    <% } else { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no && sheets[i].adsPosition == sheets[i+1].adsPosition) { %>
                            <% adsSame++; %>
                            <div class="td adsPosition noBot"></div>
                            <div class="td dimensions noBot"></div>
                        <% } else { %>
                            <div class="td adsPosition"><%= sheets[i].adsPosition %></div>
                            <div class="td dimensions"><%= sheets[i].dimensions %></div>
                            <% adsSame = 0; %>
                        <% } %>
                    <% } %>

                    <!-- set platform -->
                    <% if (platformSame) { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no && sheets[i].platform == sheets[i+1].platform) { %>
                            <% platformSame++; %>
                            <div class="td platform noTop noBot"></div>
                        <% } else { %>
                            <% trans = -1 * platformSame / 2.0 * 42.6 %>
                            <div class="td platform noTop"><div style="transform: translateY(<%- trans %>px);"><%= sheets[i].platform %></div></div>
                            <% platformSame = 0; %>
                        <% } %>
                    <% } else { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no && sheets[i].platform == sheets[i+1].platform) { %>
                            <% platformSame++; %>
                            <div class="td platform noBot"></div>
                        <% } else { %>
                            <div class="td platform"><%= sheets[i].platform %></div>
                            <% platformSame = 0; %>
                        <% } %>
                    <% } %>

                    <!-- set demo -->
                    <% if (demoSame) { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no && sheets[i].linkDemo == sheets[i+1].linkDemo) { %>
                            <% demoSame++; %>
                            <div class="td demo noTop noBot" data-link="<%= sheets[i].linkDemo %>"></div>
                        <% } else { %>
                            <% trans = -1 * demoSame / 2.0 * 42.6 %>
                            <div class="td demo noTop" data-link="<%= sheets[i].linkDemo %>"><div style="transform: translateY(<%- trans %>px); cursor: pointer;"><%= sheets[i].demo %></div></div>
                            <% demoSame = 0; %>
                        <% } %>
                    <% } else { %>
                        <% if (sheets[i+1] && sheets[i].no == sheets[i+1].no && sheets[i].linkDemo == sheets[i+1].linkDemo) { %>
                            <% demoSame++; %>
                            <div class="td demo noBot" data-link="<%= sheets[i].linkDemo %>"></div>
                        <% } else { %>
                            <div class="td demo" data-link="<%= sheets[i].linkDemo %>"><%= sheets[i].demo %></div>
                            <% demoSame = 0; %>
                        <% } %>
                    <% } %>

                    <div class="td buyingMethod"><%= sheets[i].buyingMethod %></div>
                    <div class="td detail" data-sheet="<%= JSON.stringify(sheets[i]) %>">Detail</div>
                    <div class="td note"><%= sheets[i].note %></div>
                    <div class="td action">
                        <button type="button" class="updateBtn" data-sheet="<%= JSON.stringify(sheets[i]) %>"><i class="fa-solid fa-pen"></i></button>
                        <button type="button" class="deleteBtn" data-idrow="<%= sheets[i].idRow %>"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            <% } %>
        </div>
        <div class="add"><i class="fa-solid fa-plus"></i></div>
    </div>
    <div class="getDetail">
    </div>

</body>
<script>
    $(document).ready(function(){
        $('.td.demo, .td.web').click(function() {
            var link = $(this).data('link');
            if (link) {
                window.open(link, '_blank');
            } else {
                alert('Link is not available!');
            }
        });

        $('#search_form').submit(function(event){
            event.preventDefault();
            search();
        });

        function search() {
            var searchValue = $('#search_form input[type="text"]').val().toLowerCase();
            $('.tbody .tr').hide();
            $('.tbody .header-web').hide();
            $('.tbody .tr .web[name*="' + searchValue + '"]').closest('.tr').show();
            $('.tbody .header-web:contains("' + searchValue + '")').show();
        }

        $('.td.detail').click(function(){
            var sheet = $(this).data('sheet');
            getDetail(sheet);
        });

        function getDetail(sheet) {

            var detailHTML = `
            <div class="detail-content">
                <div><center><strong>Detail</strong><center></div>
                <div class="">Website: ${ sheet.website }</div>
                <div class="ads-position">Tên vị trí: ${sheet.adsPosition }</div>
                <div class="plat-form">Nền tảng: ${sheet.platform }</div>
                <div class="buying-method">Cách tính giá: ${sheet.buyingMethod.replace(/[\u0000-\u001F]+/g, " - ") }</div>
                <hr>
                <div class="infor" style="display: flex;">
                    <div class="price">
                        <h5>Đơn giá:</h5>
                        <div>Trang chủ: ${ sheet.homepage ? sheet.homepage.toLocaleString() : "" }</div>
                        <div>Xuyên trang: ${ sheet.crossSite ? sheet.crossSite.toLocaleString() : "" }</div>
                        <div>Xuyên trang chi tiết: ${ sheet.detailCrossSite ? sheet.detailCrossSite.toLocaleString() : "" }</div>
                        <div>Chuyên mục: ${ sheet.categories ? sheet.categories.toLocaleString() : "" }</div>
                    </div>
                    <div class="performance" style="margin-left: 100px;">
                        <h5>Hiệu suất:</h5>
                        <div>CTR Trung bình: ${ sheet.averageCTR ? sheet.averageCTR : "-" }</div>
                        <div>Est Traffic: ${ sheet.estTraffic ? sheet.estTraffic : "-" }</div>
                        <div>Est Impression: ${ sheet.estImpression ? sheet.estImpression : "-" }</div>
                        <div>Est CTR: ${ sheet.estCTR ? sheet.estCTR : "-" }</div>
                    </div>
                </div>
            </div>
            <div class="Xbutton">
                <button id="Xbutton" type="button"><i class="fa-solid fa-xmark"></i></button>
            </div>
        `;
            $('.getDetail').html(detailHTML).show();

            $('#Xbutton').click(function() {
                $('.getDetail').empty().hide();
            });
        }

        $('.deleteBtn').click(async function() {
            if (confirm('Confirm to delete this line')) {
                const idRow = $(this).data('idrow');
                const data = {
                    idRow: idRow
                }
                
                fetch('http://localhost:3030/api/delete-row', {
                    method: 'DELETE',
                    headers: {
                        "Content-Type" : "application/json",
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                      throw new Error('Network response was not ok');
                    }
                    return response.json(); 
                  })
                  .then(data => {
                    alert(data.message);

                    if (data.message == 'Deleted.') {
                        $(this).closest('.tr').remove();
                    }
                  })
                  .catch(error => {
                    console.error('There was a problem with your fetch operation:', error);
                  });
            }
        });
    });
</script>
</html>